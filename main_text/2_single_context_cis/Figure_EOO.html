
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>EOO results &#8212; FunGen-xQTL Manuscript Repository</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'main_text/2_single_context_cis/Figure_EOO';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Frequency of Events in Distance Category" href="Figure_S2_single_context_cs_distance.html" />
    <link rel="prev" title="Figure 1b. Number of detectable and mappable xQTL loci in single−context fine−mapping" href="Figure_1b_num_xQTL_loci_single_context.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../README.html">
  
  
  
  
  
  
    <p class="title logo__title">FunGen-xQTL Manuscript Repository</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../README.html">
                    About
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../1_project_overview/index.html">Multi-omics QTL atlas of the aging human brain</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">Fine-mapped QTL landscape across brain molecular phenotypes</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Figure_1b_num_xQTL_loci_single_context.html">Figure 1b. Number of detectable and mappable xQTL loci in single−context fine−mapping</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">EOO results</a></li>

<li class="toctree-l2"><a class="reference internal" href="Figure_S2_single_context_cs_distance.html">Frequency of Events in Distance Category</a></li>
<li class="toctree-l2"><a class="reference internal" href="Figure_sLDSC_GWAS_specific.html">SLDSC</a></li>
<li class="toctree-l2"><a class="reference internal" href="Figure_sLDSC_meta_analysis.html">Visualization of SLDSC results</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../3_single_context_multigene_trans/index.html">Coordinated gene regulation and long-range genetic effects</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../4_multi_context/index.html">Cascading genetic effects across molecular contexts</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../4_multi_context/Figure_2b_num_xQTL_loci_multi_context.html">Number of detectable and mappable xQTL loci in ROSMAP multi−context fine−mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4_multi_context/Figure_2c_multicontext_effect_sign.html">Marginal vs multicontext effect sign heatmap</a></li>

<li class="toctree-l2"><a class="reference internal" href="../4_multi_context/Figure_watershed_posterior_plot.html">Watershed Posterior</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../5_AD_xQTL_integration/index.html">Regulatory architecture of AD susceptibility loci</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../5_AD_xQTL_integration/Figure_5a_AD_GWAS_loci_harmonized.html">AD GWAS loci harmonization and refinement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5_AD_xQTL_integration/Figure_5b_AD_GWAS_loci_properties.html">Refined AD GWAS loci properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5_AD_xQTL_integration/Figure_5c_AD_loci_xQTL_annotated.html">AD loci “explained” by xQTL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5_AD_xQTL_integration/Figure_5d_AD_loci_table_summary.html">Summary of FunGen-xQTL AD loci table</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5_AD_xQTL_integration/Figure_5e_GSEA.html">Gene Set Enrichment Analysis for AD Risk Genes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5_AD_xQTL_integration/Figure_5f_PPI.html">PPI Networks for Selected AD Risk Genes in xQTL Loci</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5_AD_xQTL_integration/Figure_5g_cV2F.html">Consensus Variant-to-Function Score for AD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5_AD_xQTL_integration/Figure_5h_GWAS_enrichment.html">GWAS Enrichment</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../6_AD_xQTL_genes/index.html">Molecular dissection of prioritized AD loci</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../6_AD_xQTL_genes/Figure_6_AD_loci_table_visualization.html">Visualization of FunGen-xQTL AD Loci Table</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../7_AD_gene_prioritized/index.html">Molecular insights and gene prioritization at key AD loci</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../7_AD_gene_prioritized/APP_case_example.html">APP</a></li>




<li class="toctree-l2"><a class="reference internal" href="../7_AD_gene_prioritized/ZYX_case_example.html">Molecular insights and gene prioritization at key AD loci</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/StatFunGen/xqtl-paper" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/StatFunGen/xqtl-paper/issues/new?title=Issue%20on%20page%20%2Fmain_text/2_single_context_cis/Figure_EOO.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/main_text/2_single_context_cis/Figure_EOO.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>EOO results</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">EOO results</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#eoo-visualization">EOO Visualization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-libraries-and-data">Load libraries and data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#barplot">Barplot</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#enrichment-plot-for-each-context">Enrichment plot for each context</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#top-combined-enrichment-plot-by-category">Top combined enrichment plot by category</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#top-combined-enrichment-plot-by-category-for-cell-type-marker">Top combined enrichment plot by category for cell type marker</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#volcano-plot">Volcano plot</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#volcano-plot-without-inf-logp">Volcano plot without Inf logP</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#volcano-plot-with-inf-logp">Volcano plot with Inf logP</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-between-methods">Test between methods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test-data">Test data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-gene-to-single-context">Multi gene to single context</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-context-to-single-context">Multi context to single context</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-of-updated-multi-context-eoo-results">Summary of Updated Multi-Context EOO Results</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="eoo-results">
<h1>EOO results<a class="headerlink" href="#eoo-results" title="Link to this heading">#</a></h1>
<p>Author: Ru Feng and Jenny Empawi</p>
<section id="eoo-visualization">
<h2>EOO Visualization<a class="headerlink" href="#eoo-visualization" title="Link to this heading">#</a></h2>
<section id="load-libraries-and-data">
<h3>Load libraries and data<a class="headerlink" href="#load-libraries-and-data" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load libraries</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">data.table</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">RColorBrewer</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">cowplot</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load EOO results</span>
<span class="n">eoo_res_all</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">readRDS</span><span class="p">(</span><span class="s">&#39;/Staging/manuscript/EOO/EOO_reshape_combined_result_withSNP_pip01_95cs_annotation_variant_level.rds&#39;</span><span class="p">)</span>

<span class="c1"># Load meta</span>
<span class="n">meta</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">fread</span><span class="p">(</span><span class="s">&quot;/restricted/projectnb/xqtl/jaempawi/xqtl/Figure_EOO/realease_data_readme.txt&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">#FIXME</span>
<span class="n">meta</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">meta</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">context_mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">basename</span><span class="p">(</span><span class="n">Path</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">gsub</span><span class="p">(</span><span class="s">&#39;.exported.toploci.bed.gz&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">.</span><span class="p">))</span>

<span class="c1"># Prepare enrichment data</span>
<span class="n">enrichment_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">eoo_res_all</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">gsub</span><span class="p">(</span><span class="s">&#39;.to_hg38&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">Annotation</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">str_detect</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="s">&#39;hg19&#39;</span><span class="p">))</span>

<span class="n">enrichment_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span>
<span class="w">    </span><span class="nf">str_detect</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;ENCFF038KTR|ENCFF015DGX|ENCFF370ANN&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="nf">str_replace</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;\\.bed$&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;.bed.gz&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="n">Annotation</span><span class="w">  </span><span class="c1"># keep original if condition not met</span>
<span class="w">  </span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">distinct</span><span class="p">()</span>

<span class="n">track_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">fread</span><span class="p">(</span><span class="s">&quot;/restricted/projectnb/xqtl/jaempawi/xqtl/Figure_EOO/categorized_annotation_tracks.csv&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">#uploaded to https://github.com/StatFunGen/xqtl-resources/tree/main/data/functional_annotations</span>

<span class="n">enrichment_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="n">enrichment_data</span><span class="p">,</span><span class="w"> </span><span class="n">track_df</span><span class="p">,</span><span class="w"> </span><span class="n">by.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;Annotation&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">by.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;Track&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">all.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">T</span><span class="p">)</span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="n">Source</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">distinct</span>

<span class="c1"># enrichment_data &lt;- enrichment_data %&gt;% mutate(Annotation = ifelse(str_detect(Annotation, &#39;ENCFF&#39;),paste0(Category, &quot;_&quot;, Annotation),Annotation))</span>
<span class="n">enrichment_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;|&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Annotation</span><span class="p">))</span>

<span class="c1"># Reorder Annotation based on the order of Category</span>
<span class="n">enrichment_data</span><span class="o">$</span><span class="n">Annotation</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="n">enrichment_data</span><span class="o">$</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="n">enrichment_data</span><span class="o">$</span><span class="n">Annotation</span><span class="p">[</span><span class="nf">order</span><span class="p">(</span><span class="n">enrichment_data</span><span class="o">$</span><span class="n">Category</span><span class="p">)]))</span>
<span class="n">enrichment_data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">head</span>

<span class="n">enrichment_data_meta</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="n">enrichment_data</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="p">,</span><span class="w"> </span><span class="n">by.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;study&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">by.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;context_mod&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">all.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">`Data Type`</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;Other&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">`Data Type`</span><span class="p">),</span>
<span class="w">         </span><span class="n">Method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Method</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;Other&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">Method</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;single_context_finemapping&#39;</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nf">str_detect</span><span class="p">(</span><span class="n">Modality</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Inh|Exc|OPC|Oli|Mic|Ast&#39;</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;snuc_eQTL&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">`Data Type`</span><span class="w"> </span><span class="p">),</span>
<span class="w">         </span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">Method</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;multi_gene_finemapping&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;multi_gene&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">`Data Type`</span><span class="w"> </span><span class="p">),</span>
<span class="w">         </span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;multicontext&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;multi_context&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">`Data Type`</span><span class="w"> </span><span class="p">),</span>
<span class="w">         </span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">str_detect</span><span class="p">(</span><span class="n">study</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;haQTL|mQTL&#39;</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;Epi&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">`Data Type`</span><span class="w"> </span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 6 × 21</caption>
<thead>
	<tr><th></th><th scope=col>Annotation</th><th scope=col>OR</th><th scope=col>OR_SE</th><th scope=col>OR_log2</th><th scope=col>OR_SE_log2</th><th scope=col>Enrichment</th><th scope=col>Enrichment_SE</th><th scope=col>Enrichment_log2</th><th scope=col>Enrichment_SE_log2</th><th scope=col>study</th><th scope=col>⋯</th><th scope=col>annotation</th><th scope=col>annotation_sets</th><th scope=col>Enrichment_Z_score</th><th scope=col>Enrichment_P_value</th><th scope=col>Z_or</th><th scope=col>P_or</th><th scope=col>Assay</th><th scope=col>Data_Category</th><th scope=col>Cell_Type</th><th scope=col>Category</th></tr>
	<tr><th></th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>⋯</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>Transcription_Factor_Binding|1_GATA2-Interval-Track</td><td>1.809502</td><td>0.11650544</td><td>0.8555927</td><td>0.09286834</td><td>1.783705</td><td>0.11105414</td><td>0.8347443</td><td>0.08981472</td><td>Oli_DeJager_eQTL_multicontext  </td><td>⋯</td><td>NA</td><td>NA</td><td>16.061585</td><td> 4.742789e-58</td><td>NA</td><td>NA</td><td></td><td></td><td></td><td>Transcription_Factor_Binding</td></tr>
	<tr><th scope=row>2</th><td>Transcription_Factor_Binding|1_GATA2-Interval-Track</td><td>2.347758</td><td>0.46736472</td><td>1.2312838</td><td>0.29880894</td><td>2.296091</td><td>0.43987546</td><td>1.1978521</td><td>0.28743723</td><td>Mic_Kellis_eQTL_multicontext   </td><td>⋯</td><td>NA</td><td>NA</td><td> 5.219866</td><td> 1.790524e-07</td><td>NA</td><td>NA</td><td></td><td></td><td></td><td>Transcription_Factor_Binding</td></tr>
	<tr><th scope=row>3</th><td>Transcription_Factor_Binding|1_GATA2-Interval-Track</td><td>1.707677</td><td>0.09218601</td><td>0.7720348</td><td>0.07769254</td><td>1.686189</td><td>0.08812173</td><td>0.7536727</td><td>0.07522796</td><td>Ast_DeJager_eQTL_multicontext  </td><td>⋯</td><td>NA</td><td>NA</td><td>19.134770</td><td> 1.296498e-81</td><td>NA</td><td>NA</td><td></td><td></td><td></td><td>Transcription_Factor_Binding</td></tr>
	<tr><th scope=row>4</th><td>Transcription_Factor_Binding|1_GATA2-Interval-Track</td><td>1.600990</td><td>0.07593498</td><td>0.6789646</td><td>0.06826243</td><td>1.582428</td><td>0.07270452</td><td>0.6620679</td><td>0.06613290</td><td>DLPFC_DeJager_eQTL_multicontext</td><td>⋯</td><td>NA</td><td>NA</td><td>21.765198</td><td>4.959513e-105</td><td>NA</td><td>NA</td><td></td><td></td><td></td><td>Transcription_Factor_Binding</td></tr>
	<tr><th scope=row>5</th><td>Transcription_Factor_Binding|1_GATA2-Interval-Track</td><td>1.826027</td><td>0.14506736</td><td>0.8687084</td><td>0.11530654</td><td>1.800184</td><td>0.13848111</td><td>0.8479395</td><td>0.11164329</td><td>OPC_DeJager_eQTL_multicontext  </td><td>⋯</td><td>NA</td><td>NA</td><td>12.999492</td><td> 1.231594e-38</td><td>NA</td><td>NA</td><td></td><td></td><td></td><td>Transcription_Factor_Binding</td></tr>
	<tr><th scope=row>6</th><td>Transcription_Factor_Binding|1_GATA2-Interval-Track</td><td>1.586308</td><td>0.14484476</td><td>0.6656734</td><td>0.13222318</td><td>1.570301</td><td>0.13950901</td><td>0.6507685</td><td>0.12866153</td><td>DLPFC_Bennett_pQTL_multicontext</td><td>⋯</td><td>NA</td><td>NA</td><td>11.255910</td><td> 2.165796e-29</td><td>NA</td><td>NA</td><td></td><td></td><td></td><td>Transcription_Factor_Binding</td></tr>
</tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set your working directory</span>
<span class="n">main_output_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w">  </span><span class="c1">#Insert your working directory</span>
<span class="nf">dir.create</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="n">recursive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">showWarnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="barplot">
<h2>Barplot<a class="headerlink" href="#barplot" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get original Set2 colors (8)</span>
<span class="n">set2_colors</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">brewer.pal</span><span class="p">(</span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Set3&quot;</span><span class="p">)</span>

<span class="c1"># Generate extra colors in a similar style</span>
<span class="n">n_cat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">enrichment_data</span><span class="o">$</span><span class="n">Category</span><span class="p">))</span>
<span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">n_cat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">extra_colors</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">hue_pal</span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">30</span><span class="p">,</span><span class="w"> </span><span class="m">300</span><span class="p">),</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">70</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">70</span><span class="p">)(</span><span class="n">n_cat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">8</span><span class="p">)</span>
<span class="w">  </span><span class="n">all_colors</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">set2_colors</span><span class="p">,</span><span class="w"> </span><span class="n">extra_colors</span><span class="p">)</span>
<span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">all_colors</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">set2_colors</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="n">n_cat</span><span class="p">]</span>
<span class="p">}</span>

<span class="nf">theme_set</span><span class="p">(</span><span class="nf">theme_minimal</span><span class="p">(</span><span class="n">base_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Roboto&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<section id="enrichment-plot-for-each-context">
<h3>Enrichment plot for each context<a class="headerlink" href="#enrichment-plot-for-each-context" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># List to store all plots for user access</span>
<span class="n">all_plots</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span>

<span class="kr">for</span><span class="p">(</span><span class="n">context</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="n">enrichment_data</span><span class="o">$</span><span class="n">study</span><span class="p">)){</span>
<span class="w">      </span><span class="nf">options</span><span class="p">(</span><span class="n">warn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1</span><span class="p">)</span><span class="w">  </span><span class="c1"># suppress warning</span>
<span class="w">      </span><span class="c1"># Get method for directory organization</span>
<span class="w">      </span><span class="n">dir_method</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">meta</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">context_mod</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">pull</span><span class="p">(</span><span class="n">Method</span><span class="p">)</span>
<span class="w">      </span><span class="kr">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">dir_method</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="n">dir_method</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&#39;Other&#39;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Create method-specific subdirectory</span>
<span class="w">      </span><span class="n">method_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="n">dir_method</span><span class="p">)</span>
<span class="w">      </span><span class="nf">dir.create</span><span class="p">(</span><span class="n">method_dir</span><span class="p">,</span><span class="w"> </span><span class="n">recursive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">showWarnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Prepare data</span>
<span class="w">      </span><span class="n">dat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">filter</span><span class="p">(</span>
<span class="w">          </span><span class="n">study</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">context</span><span class="p">,</span>
<span class="w">          </span><span class="n">Enrichment_P_value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">group_by</span><span class="p">(</span><span class="n">Category</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="n">Enrichment_log2</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">slice_head</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">mutate</span><span class="p">(</span>
<span class="w">          </span><span class="n">Annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">reorder</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_log2</span><span class="p">),</span>
<span class="w">          </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_log2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Enrichment_SE_log2</span><span class="p">,</span>
<span class="w">          </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_log2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Enrichment_SE_log2</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">distinct</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">.keep_all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Create plot     </span>
<span class="w">      </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ggplot</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_log2</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Category</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">geom_col</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="c1"># Remove stat = &quot;identity&quot; - it&#39;s not needed for geom_col</span>
<span class="w">        </span><span class="nf">geom_errorbar</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ymin</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ymax</span><span class="p">),</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">coord_flip</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">14</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">labs</span><span class="p">(</span>
<span class="w">          </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Annotation&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;log2(Enrichment Score)&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">          </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Annotation Set&quot;</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_colors</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">theme</span><span class="p">(</span>
<span class="w">            </span><span class="n">axis.title.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="p">),</span>
<span class="w">            </span><span class="n">axis.title.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="p">),</span>
<span class="w">            </span><span class="n">plot.margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unit</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span><span class="m">0.2</span><span class="p">,</span><span class="w"> </span><span class="m">0.2</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;cm&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;right&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1"># Move legend to lower right</span>
<span class="w">            </span><span class="n">legend.justification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;center&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1"># Anchor legend&#39;s bottom-right corner</span>
<span class="w">            </span><span class="n">legend.spacing.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unit</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cm&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="n">panel.spacing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unit</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cm&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="n">legend.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey50&quot;</span><span class="p">),</span>
<span class="w">            </span><span class="n">legend.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="p">),</span>
<span class="w">            </span><span class="n">legend.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">)</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">      </span><span class="n">title_grob</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ggdraw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">draw_label</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Enrichment across Annotations: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">),</span><span class="w"> </span><span class="n">fontface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">28</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,)</span>
<span class="w">      </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">plot_grid</span><span class="p">(</span><span class="n">title_grob</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">rel_heights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="w">    </span>
<span class="w">      </span><span class="c1"># Save plot to file</span>
<span class="w">      </span><span class="n">output_file</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">method_dir</span><span class="p">,</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_enrichment_plot.pdf&#39;</span><span class="p">))</span>
<span class="w">      </span><span class="nf">ggsave</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">limitsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Store plot in list for user access</span>
<span class="w">      </span><span class="n">all_plots</span><span class="p">[[</span><span class="n">context</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p</span>
<span class="p">}</span>

<span class="c1"># Display one example plot</span>
<span class="kr">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">all_plots</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">example_context</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_plots</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span>
<span class="w">  </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Displaying example plot for:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">example_context</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">  </span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="p">)</span>
<span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="n">all_plots</span><span class="p">[[</span><span class="n">example_context</span><span class="p">]])</span>
<span class="p">}</span>

<span class="c1"># Function to display any plot by context name</span>
<span class="n">display_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">context_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">if</span><span class="p">(</span><span class="n">context_name</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Displaying plot for:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">context_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="n">all_plots</span><span class="p">[[</span><span class="n">context_name</span><span class="p">]])</span><span class="w">  </span><span class="c1"># Add this line</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Plot not found for context:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">context_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Available contexts:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">paste</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">all_plots</span><span class="p">),</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Function to save individual plot to different location</span>
<span class="n">save_individual_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">context_name</span><span class="p">,</span><span class="w"> </span><span class="n">file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">if</span><span class="p">(</span><span class="n">context_name</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">if</span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">file_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">context_name</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_custom_export.pdf&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nf">ggsave</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_plots</span><span class="p">[[</span><span class="n">context_name</span><span class="p">]],</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">limitsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">  </span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Saved custom export to:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Plot not found for context:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">context_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Print summary quietly</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;\n=== PLOT PROCESSING COMPLETE ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Total plots created:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">all_plots</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n\n&quot;</span><span class="p">)</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;=== AVAILABLE FUNCTIONS ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• display_plot(&#39;context_name&#39;) - Show any plot\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• list_plots() - See all available plots\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• save_individual_plot(&#39;context_name&#39;) - Export specific plot\n\n&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Displaying example plot for: Oli_DeJager_eQTL_multicontext 

=== PLOT PROCESSING COMPLETE ===
Total plots created: 142 

=== AVAILABLE FUNCTIONS ===
• display_plot(&#39;context_name&#39;) - Show any plot
• list_plots() - See all available plots
• save_individual_plot(&#39;context_name&#39;) - Export specific plot
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/10b9c6d252a2348b5ae63db7b95fc16cf1358eab59622bffe49b7cba937d7d34.png"><img alt="../../_images/10b9c6d252a2348b5ae63db7b95fc16cf1358eab59622bffe49b7cba937d7d34.png" src="../../_images/10b9c6d252a2348b5ae63db7b95fc16cf1358eab59622bffe49b7cba937d7d34.png" style="width: 3600px; height: 3600px;" />
</a>
</div>
</div>
</section>
<section id="top-combined-enrichment-plot-by-category">
<h3>Top combined enrichment plot by category<a class="headerlink" href="#top-combined-enrichment-plot-by-category" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">top_num</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2</span>

<span class="c1"># List to store all plots for user access</span>
<span class="n">all_combined_plots</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span>

<span class="kr">for</span><span class="p">(</span><span class="n">top_num</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">)){</span>
<span class="w">      </span><span class="n">enrichment_data_top_category</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_meta</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">filter</span><span class="p">(</span><span class="n">Enrichment_P_value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="nf">str_detect</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;ENCFF&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span>
<span class="w">                                   </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="n">Annotation</span><span class="p">[</span><span class="nf">order</span><span class="p">(</span><span class="n">Category</span><span class="p">)])))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">group_by</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span><span class="w"> </span><span class="n">study</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="n">Enrichment_log2</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">slice_head</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top_num</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="n">plot_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_top_category</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">Method</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&#39;trans_finemapping&#39;</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="n">dir_name</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&#39;condense_top&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">top_num</span><span class="p">)</span>
<span class="w">      </span><span class="n">dir_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="n">dir_name</span><span class="p">)</span>
<span class="w">      </span><span class="nf">dir.create</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="n">recursive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">showWarnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="n">data_type</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">na.omit</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">plot_data</span><span class="o">$</span><span class="n">`Data Type`</span><span class="p">)),</span><span class="w"> </span><span class="s">&#39;all&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">data_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;all&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">          </span><span class="nf">ggplot</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Annotation</span><span class="p">,</span>
<span class="w">                     </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_log2</span><span class="p">,</span>
<span class="w">                     </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Category</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">geom_col</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">geom_errorbar</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_log2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Enrichment_SE_log2</span><span class="p">,</span>
<span class="w">                            </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_log2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Enrichment_SE_log2</span><span class="p">),</span>
<span class="w">                        </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">study</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;free_y&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">coord_flip</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">theme_bw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Enrichment across Annotations - Top&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">top_num</span><span class="p">),</span>
<span class="w">               </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Annotation&quot;</span><span class="p">,</span>
<span class="w">               </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;log2(Enrichment Score)&quot;</span><span class="p">,</span><span class="w">  </span>
<span class="w">               </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Annotation Set&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_colors</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">theme</span><span class="p">(</span>
<span class="w">              </span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">28</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">),</span><span class="w">       </span>
<span class="w">              </span><span class="n">axis.title.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">),</span>
<span class="w">              </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">),</span><span class="w">  </span>
<span class="w">              </span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">),</span><span class="w">  </span>
<span class="w">              </span><span class="n">strip.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span><span class="p">)</span>
<span class="w">          </span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1"># Save plot to organized directory</span>
<span class="w">        </span><span class="n">output</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_top&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">top_num</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_enrichment_plot_combined.pdf&#39;</span><span class="p">))</span>
<span class="w">        </span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">data_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;all&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">width</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">100</span>
<span class="w">          </span><span class="n">height</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">top_num</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="c1"># Dynamically calculate size based on the number of facets</span>
<span class="w">          </span><span class="n">num_facets</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">`Data Type`</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">study</span><span class="p">))</span>
<span class="w">  </span>
<span class="w">          </span><span class="kr">if</span><span class="p">(</span><span class="n">num_facets</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">height</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_facets</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">top_num</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1.5</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">height</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_facets</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">top_num</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">          </span><span class="kr">if</span><span class="p">(</span><span class="n">num_facets</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">width</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_facets</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">2.5</span><span class="w"> </span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_facets</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">width</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_facets</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">width</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_facets</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">6</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>
<span class="w">        </span>
<span class="w">        </span><span class="nf">ggsave</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">limitsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1"># Store plot for user access</span>
<span class="w">        </span><span class="n">plot_key</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;top&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">top_num</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">        </span><span class="n">all_combined_plots</span><span class="p">[[</span><span class="n">plot_key</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p</span>
<span class="w">      </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Function to display any combined plot</span>
<span class="n">display_combined_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">top_num</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">plot_key</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;top&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">top_num</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">  </span><span class="kr">if</span><span class="p">(</span><span class="n">plot_key</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_combined_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Displaying plot:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="nf">print</span><span class="p">(</span><span class="n">all_combined_plots</span><span class="p">[[</span><span class="n">plot_key</span><span class="p">]])</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Plot not found:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Available combined plots:\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">all_combined_plots</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Function to list all available combined plots</span>
<span class="n">list_combined_plots</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Available combined plots:\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="kr">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">all_combined_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_combined_plots</span><span class="p">)[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Function to save individual combined plot to custom location</span>
<span class="n">save_combined_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">top_num</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="n">file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">plot_key</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;top&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">top_num</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">  </span><span class="kr">if</span><span class="p">(</span><span class="n">plot_key</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_combined_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">if</span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">file_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_custom_export.pdf&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nf">ggsave</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_combined_plots</span><span class="p">[[</span><span class="n">plot_key</span><span class="p">]],</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">limitsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Saved custom export to:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Plot not found:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Print summary</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;\n=== COMBINED PLOT PROCESSING COMPLETE ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Total combined plots created:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">all_combined_plots</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;All figures saved to subdirectories:\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;  -&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;condense_top1&#39;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;  -&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;condense_top2&#39;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;File pattern: [data_type]_top[number]_enrichment_plot_combined.pdf\n\n&quot;</span><span class="p">)</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;=== AVAILABLE FUNCTIONS ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• display_combined_plot(top_num, &#39;data_type&#39;) - Show any combined plot in notebook\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• list_combined_plots() - See all available combined plots\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• save_combined_plot(top_num, &#39;data_type&#39;) - Export specific combined plot\n\n&quot;</span><span class="p">)</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;=== TO VIEW YOUR FIGURES ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;1. Open the directories: condense_top1/ and condense_top2/\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;2. Look for files named: [data_type]_top[1|2]_enrichment_plot_combined.pdf\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;3. Data types include: all, snuc_eQTL, multi_gene, multi_context, Epi, Other\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;4. Use display_combined_plot(top_num, &#39;data_type&#39;) to view any plot in this notebook\n&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== COMBINED PLOT PROCESSING COMPLETE ===
Total combined plots created: 18 
All figures saved to subdirectories:
  - /restricted/projectnb/xqtl/jaempawi/xqtl/Figure_EOO/condense_top1 
  - /restricted/projectnb/xqtl/jaempawi/xqtl/Figure_EOO/condense_top2 
File pattern: [data_type]_top[number]_enrichment_plot_combined.pdf

=== AVAILABLE FUNCTIONS ===
• display_combined_plot(top_num, &#39;data_type&#39;) - Show any combined plot in notebook
• list_combined_plots() - See all available combined plots
• save_combined_plot(top_num, &#39;data_type&#39;) - Export specific combined plot

=== TO VIEW YOUR FIGURES ===
1. Open the directories: condense_top1/ and condense_top2/
2. Look for files named: [data_type]_top[1|2]_enrichment_plot_combined.pdf
3. Data types include: all, snuc_eQTL, multi_gene, multi_context, Epi, Other
4. Use display_combined_plot(top_num, &#39;data_type&#39;) to view any plot in this notebook
</pre></div>
</div>
</div>
</div>
</section>
<section id="top-combined-enrichment-plot-by-category-for-cell-type-marker">
<h3>Top combined enrichment plot by category for cell type marker<a class="headerlink" href="#top-combined-enrichment-plot-by-category-for-cell-type-marker" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">top_num</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2</span>

<span class="c1"># List to store all plots for user access</span>
<span class="n">all_celltype_plots</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span>

<span class="n">enrichment_data_top_category</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_meta</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">filter</span><span class="p">(</span><span class="n">Enrichment_P_value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="p">,</span><span class="w"> </span><span class="nf">str_detect</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;CellType&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span>
<span class="w">                             </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="n">Annotation</span><span class="p">[</span><span class="nf">order</span><span class="p">(</span><span class="n">Category</span><span class="p">)])))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">group_by</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span><span class="w"> </span><span class="n">study</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="n">Enrichment_log2</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">slice_head</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top_num</span><span class="p">)</span>

<span class="c1"># No need for merge - use the Data Type already in enrichment_data_meta</span>
<span class="c1"># Just apply the specific celltype data type logic</span>
<span class="n">plot_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_top_category</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span>
<span class="w">    </span><span class="nf">str_detect</span><span class="p">(</span><span class="n">study</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;AC|PCC|DLPFC|MSBB|Knight&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&#39;eQTL&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nf">str_detect</span><span class="p">(</span><span class="n">study</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;Inh|Exc|Oli|OPC|Mic|Ast|monocyte&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&#39;snuc_eQTL&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nf">str_detect</span><span class="p">(</span><span class="n">study</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;pQTL&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&#39;pQTL&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="kc">TRUE</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&#39;LR&#39;</span><span class="w">  </span><span class="c1"># Default case</span>
<span class="w">  </span><span class="p">))</span>

<span class="n">dir_name</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&#39;condense_top&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">top_num</span><span class="p">)</span>
<span class="n">dir_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="n">dir_name</span><span class="p">)</span>
<span class="nf">dir.create</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="n">recursive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">showWarnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>

<span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="n">data_type</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">na.omit</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">plot_data</span><span class="o">$</span><span class="n">`Data Type`</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span>
<span class="w">  </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">  </span>
<span class="w">  </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="nf">ggplot</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Annotation</span><span class="p">,</span>
<span class="w">               </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_log2</span><span class="p">,</span>
<span class="w">               </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Category</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">geom_col</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">geom_errorbar</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_log2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Enrichment_SE_log2</span><span class="p">,</span>
<span class="w">                      </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_log2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Enrichment_SE_log2</span><span class="p">),</span>
<span class="w">                  </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">study</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;free_y&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="o">=</span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">coord_flip</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">theme_bw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;CellType Marker Enrichment - Top&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">top_num</span><span class="p">),</span>
<span class="w">         </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Annotation&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;log2(Enrichment Score)&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">         </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Annotation Set&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_colors</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="nf">theme</span><span class="p">(</span>
<span class="w">        </span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">28</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">),</span><span class="w">       </span>
<span class="w">        </span><span class="n">axis.title.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">),</span>
<span class="w">        </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">),</span><span class="w">  </span>
<span class="w">        </span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">),</span><span class="w">  </span>
<span class="w">        </span><span class="n">strip.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span><span class="p">))</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Save plot to organized directory</span>
<span class="w">  </span><span class="n">output</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_top&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">top_num</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_withENCFF_enrichment_plot_combined.pdf&#39;</span><span class="p">))</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Dynamically calculate size based on the number of facets</span>
<span class="w">  </span><span class="n">num_facets</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">`Data Type`</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">study</span><span class="p">))</span>

<span class="w">  </span><span class="kr">if</span><span class="p">(</span><span class="n">num_facets</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">height</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_facets</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">top_num</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1.5</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">height</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_facets</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">top_num</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kr">if</span><span class="p">(</span><span class="n">num_facets</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">width</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_facets</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">2.5</span><span class="w"> </span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_facets</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">width</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_facets</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">width</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_facets</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">6</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="nf">ggsave</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">limitsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Store plot for user access</span>
<span class="w">  </span><span class="n">plot_key</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;celltype_top&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">top_num</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">  </span><span class="n">all_celltype_plots</span><span class="p">[[</span><span class="n">plot_key</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p</span>
<span class="p">}</span>

<span class="c1"># Function to display any celltype plot</span>
<span class="n">display_celltype_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">plot_key</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;celltype_top5_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">  </span><span class="kr">if</span><span class="p">(</span><span class="n">plot_key</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_celltype_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Displaying plot:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="nf">print</span><span class="p">(</span><span class="n">all_celltype_plots</span><span class="p">[[</span><span class="n">plot_key</span><span class="p">]])</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Plot not found:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Available celltype plots:\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">all_celltype_plots</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Function to list all available celltype plots</span>
<span class="n">list_celltype_plots</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Available celltype plots:\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="kr">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">all_celltype_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_celltype_plots</span><span class="p">)[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Function to save individual celltype plot to custom location</span>
<span class="n">save_celltype_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="n">file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">plot_key</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;celltype_top5_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">  </span><span class="kr">if</span><span class="p">(</span><span class="n">plot_key</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_celltype_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">if</span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">file_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_custom_export.pdf&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nf">ggsave</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_celltype_plots</span><span class="p">[[</span><span class="n">plot_key</span><span class="p">]],</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">limitsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Saved custom export to:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Plot not found:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Print summary</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;\n=== CELLTYPE PLOT PROCESSING COMPLETE ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Total celltype plots created:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">all_celltype_plots</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;All figures saved to:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;File pattern: [data_type]_top&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">top_num</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_withENCFF_enrichment_plot_combined.pdf\n\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;=== AVAILABLE FUNCTIONS ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• display_celltype_plot(&#39;data_type&#39;) - Show any celltype plot in notebook\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• list_celltype_plots() - See all available celltype plots\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• save_celltype_plot(&#39;data_type&#39;) - Export specific celltype plot\n\n&quot;</span><span class="p">)</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;=== TO VIEW YOUR FIGURES ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;1. Open the directory:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;2. Look for files named: [data_type]_top&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">top_num</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_withENCFF_enrichment_plot_combined.pdf\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;3. Data types include:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">paste</span><span class="p">(</span><span class="nf">na.omit</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">plot_data</span><span class="o">$</span><span class="n">`Data Type`</span><span class="p">)),</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;4. Use display_celltype_plot(&#39;data_type&#39;) to view any plot in this notebook\n&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== CELLTYPE PLOT PROCESSING COMPLETE ===
Total celltype plots created: 4 
All figures saved to: /restricted/projectnb/xqtl/jaempawi/xqtl/Figure_EOO/condense_top2 
File pattern: [data_type]_top2_withENCFF_enrichment_plot_combined.pdf

=== AVAILABLE FUNCTIONS ===
• display_celltype_plot(&#39;data_type&#39;) - Show any celltype plot in notebook
• list_celltype_plots() - See all available celltype plots
• save_celltype_plot(&#39;data_type&#39;) - Export specific celltype plot

=== TO VIEW YOUR FIGURES ===
1. Open the directory: /restricted/projectnb/xqtl/jaempawi/xqtl/Figure_EOO/condense_top2 
2. Look for files named: [data_type]_top2_withENCFF_enrichment_plot_combined.pdf
3. Data types include: eQTL, snuc_eQTL, LR, pQTL 
4. Use display_celltype_plot(&#39;data_type&#39;) to view any plot in this notebook
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="volcano-plot">
<h2>Volcano plot<a class="headerlink" href="#volcano-plot" title="Link to this heading">#</a></h2>
<section id="volcano-plot-without-inf-logp">
<h3>Volcano plot without Inf logP<a class="headerlink" href="#volcano-plot-without-inf-logp" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># List to store all plots for user access</span>
<span class="n">all_volcano_plots</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span>

<span class="n">plot_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_meta</span><span class="w"> </span>

<span class="n">dir_name</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&#39;volcano&#39;</span>
<span class="n">dir_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="n">dir_name</span><span class="p">)</span>
<span class="nf">dir.create</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="n">recursive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">showWarnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Creating volcano plots in:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="n">data_type</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">na.omit</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">plot_data</span><span class="o">$</span><span class="n">`Data Type`</span><span class="p">)),</span><span class="w"> </span><span class="s">&#39;all&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">data_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;all&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Category</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Enrichment_P_value</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">mutate</span><span class="p">(</span><span class="n">logP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nf">log10</span><span class="p">(</span><span class="n">Enrichment_P_value</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">ggplot</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_log2</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logP</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logP</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logP</span><span class="p">),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.6</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">facet_grid</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">study</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">Category</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fixed&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">scale_color_gradientn</span><span class="p">(</span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;blue&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;grey&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="p">),</span>
<span class="w">                              </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;-log10(P)&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">scale_size_continuous</span><span class="p">(</span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">),</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;-log10(P)&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">14</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">theme</span><span class="p">(</span>
<span class="w">          </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="w">          </span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey90&quot;</span><span class="p">),</span>
<span class="w">          </span><span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">),</span>
<span class="w">          </span><span class="n">plot.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">),</span>
<span class="w">          </span><span class="n">strip.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey95&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey70&quot;</span><span class="p">),</span>
<span class="w">          </span><span class="n">strip.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">),</span>
<span class="w">          </span><span class="n">axis.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">),</span>
<span class="w">          </span><span class="n">axis.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">28</span><span class="p">),</span>
<span class="w">          </span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;right&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="n">legend.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">),</span>
<span class="w">          </span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">28</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">),</span>
<span class="w">          </span><span class="n">plot.subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">),</span>
<span class="w">          </span><span class="n">legend.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">),</span>
<span class="w">          </span><span class="n">legend.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">labs</span><span class="p">(</span>
<span class="w">          </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Volcano Plot: Enrichment Analysis -&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">),</span>
<span class="w">          </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;log2(Enrichment) vs -log10(P-value)&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;log2(Enrichment)&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;-log10(P-value)&quot;</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Save plot to organized directory</span>
<span class="w">      </span><span class="n">output</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_enrichment_volcano_plot_combined.pdf&#39;</span><span class="p">))</span>
<span class="w">      </span>
<span class="w">      </span><span class="n">width</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">45</span>
<span class="w">      </span><span class="n">height</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">study</span><span class="p">))</span>
<span class="w">      </span><span class="nf">ggsave</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">limitsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Store plot for user access</span>
<span class="w">      </span><span class="n">plot_key</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;volcano_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">      </span><span class="n">all_volcano_plots</span><span class="p">[[</span><span class="n">plot_key</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p</span>
<span class="p">}</span>


<span class="c1"># Function to display any volcano plot</span>
<span class="n">display_volcano_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">plot_key</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;volcano_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">  </span><span class="kr">if</span><span class="p">(</span><span class="n">plot_key</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Displaying plot:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="c1"># Set dimensions for this specific display</span>
<span class="w">    </span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="p">)</span>
<span class="w">      </span><span class="nf">print</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">[[</span><span class="n">plot_key</span><span class="p">]])</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Plot not found:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Available volcano plots:\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Function to list all available volcano plots</span>
<span class="n">list_volcano_plots</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Available volcano plots:\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="kr">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">)[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Function to save individual volcano plot to custom location</span>
<span class="n">save_volcano_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="n">file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">plot_key</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;volcano_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">  </span><span class="kr">if</span><span class="p">(</span><span class="n">plot_key</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">if</span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">file_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_custom_export.pdf&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">        </span><span class="nf">ggsave</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_volcano_plots</span><span class="p">[[</span><span class="n">plot_key</span><span class="p">]],</span><span class="w"> </span>
<span class="w">               </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">,</span><span class="w"> </span><span class="n">limitsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Saved custom export to:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Plot not found:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Print summary</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;\n=== VOLCANO PLOT PROCESSING COMPLETE ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Total volcano plots created:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n\n&quot;</span><span class="p">)</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;=== AVAILABLE FUNCTIONS ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• display_volcano_plot(&#39;data_type&#39;) - Show any volcano plot\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• list_volcano_plots() - See all available volcano plots\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• save_volcano_plot(&#39;data_type&#39;) - Export specific volcano plot\n\n&quot;</span><span class="p">)</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;=== TO VIEW YOUR FIGURES ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;1. Open the directory:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;2. Look for files named: [data_type]_enrichment_volcano_plot_combined.pdf\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;3. Data types include: all, snuc_eQTL, multi_gene, multi_context, Epi, Other\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;4. Use display_volcano_plot(&#39;data_type&#39;) to view any plot in this notebook\n&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== VOLCANO PLOT PROCESSING COMPLETE ===
Total volcano plots created: 10 

=== AVAILABLE FUNCTIONS ===
• display_volcano_plot(&#39;data_type&#39;) - Show any volcano plot
• list_volcano_plots() - See all available volcano plots
• save_volcano_plot(&#39;data_type&#39;) - Export specific volcano plot

=== TO VIEW YOUR FIGURES ===
1. Open the directory: /restricted/projectnb/xqtl/jaempawi/xqtl/Figure_EOO/volcano 
2. Look for files named: [data_type]_enrichment_volcano_plot_combined.pdf
3. Data types include: all, snuc_eQTL, multi_gene, multi_context, Epi, Other
4. Use display_volcano_plot(&#39;data_type&#39;) to view any plot in this notebook
</pre></div>
</div>
</div>
</div>
</section>
<section id="volcano-plot-with-inf-logp">
<h3>Volcano plot with Inf logP<a class="headerlink" href="#volcano-plot-with-inf-logp" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># List to store all volcano plots for user access</span>
<span class="n">all_volcano_plots</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span>

<span class="n">plot_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_meta</span>

<span class="n">dir_name</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&#39;volcano_Inf&#39;</span>
<span class="n">dir_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="n">dir_name</span><span class="p">)</span>
<span class="nf">dir.create</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="n">recursive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">showWarnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">    </span>
<span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="n">data_type</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">na.omit</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">plot_data</span><span class="o">$</span><span class="n">`Data Type`</span><span class="p">)),</span><span class="w"> </span><span class="s">&#39;all&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">data_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;all&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data</span>
<span class="w">     </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">     </span><span class="p">}</span><span class="w">    </span>
<span class="w">    </span><span class="c1"># Filter and compute logP</span>
<span class="w">    </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Category</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Enrichment_P_value</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="nf">mutate</span><span class="p">(</span><span class="n">logP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nf">log10</span><span class="p">(</span><span class="n">Enrichment_P_value</span><span class="p">))</span>
<span class="w">      </span>
<span class="w">    </span><span class="c1"># Calculate percentiles for highlighting</span>
<span class="w">    </span><span class="n">logP_top</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">quantile</span><span class="p">(</span>
<span class="w">    </span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">logP</span><span class="p">[</span><span class="nf">is.finite</span><span class="p">(</span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">logP</span><span class="p">)],</span><span class="w"> </span><span class="m">0.99</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="w">    </span><span class="n">enrich_top</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">quantile</span><span class="p">(</span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">Enrichment_log2</span><span class="p">[</span><span class="nf">is.finite</span><span class="p">(</span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">Enrichment_log2</span><span class="p">)],</span><span class="w"> </span><span class="m">0.95</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">    </span><span class="c1"># Handle infinite values with cap and jitter</span>
<span class="w">    </span><span class="n">finite_logP</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">logP</span><span class="p">[</span><span class="nf">is.finite</span><span class="p">(</span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">logP</span><span class="p">)]</span>
<span class="w">    </span><span class="n">cap_base</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">finite_logP</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">10</span>
<span class="w">    </span><span class="n">n_inf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="nf">is.infinite</span><span class="p">(</span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">logP</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="w">    </span><span class="n">jitter_values</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">runif</span><span class="p">(</span><span class="n">n_inf</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">    </span><span class="c1"># Create temporary jitter index</span>
<span class="w">    </span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">jitter_index</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span>
<span class="w">    </span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">jitter_index</span><span class="p">[</span><span class="nf">is.infinite</span><span class="p">(</span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">logP</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq_len</span><span class="p">(</span><span class="n">n_inf</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">    </span><span class="c1"># Apply cap and jitter</span>
<span class="w">    </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="nf">mutate</span><span class="p">(</span><span class="n">logP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span><span class="nf">is.infinite</span><span class="p">(</span><span class="n">logP</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">cap_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jitter_values</span><span class="p">[</span><span class="n">jitter_index</span><span class="p">],</span><span class="w"> </span><span class="kc">TRUE</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">logP</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="n">jitter_index</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">    </span><span class="c1"># Create the plot</span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">plot_data_tmp</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">mutate</span><span class="p">(</span><span class="n">highlight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logP</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">logP_top</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Enrichment_log2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">enrich_top</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">ggplot</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_log2</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logP</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logP</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logP</span><span class="p">),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">geom_point</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="nf">filter</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">highlight</span><span class="p">),</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">21</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#CD2626&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logP</span><span class="p">),</span><span class="w"> </span><span class="n">stroke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">facet_grid</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">study</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">Category</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fixed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">labeller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">labeller</span><span class="p">(</span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">label_wrap_gen</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">scale_color_gradientn</span><span class="p">(</span><span class="n">colors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;blue&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;grey&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;#FF6A6A&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;-log10(P)&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">scale_size_continuous</span><span class="p">(</span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">),</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;-log10(P)&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">coord_cartesian</span><span class="p">(</span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">logP</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1.1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">14</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">theme</span><span class="p">(</span>
<span class="w">          </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="w">          </span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey90&quot;</span><span class="p">),</span>
<span class="w">          </span><span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">),</span>
<span class="w">          </span><span class="n">plot.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">),</span>
<span class="w">          </span><span class="n">strip.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey95&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey70&quot;</span><span class="p">),</span>
<span class="w">          </span><span class="n">strip.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">),</span>
<span class="w">          </span><span class="n">axis.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">),</span>
<span class="w">          </span><span class="n">axis.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">28</span><span class="p">),</span>
<span class="w">          </span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;right&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="n">legend.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_rect</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">),</span>
<span class="w">          </span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">28</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">),</span>
<span class="w">          </span><span class="n">plot.subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="p">),</span>
<span class="w">          </span><span class="n">legend.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">),</span>
<span class="w">          </span><span class="n">legend.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="nf">labs</span><span class="p">(</span>
<span class="w">          </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Volcano Plot: Enrichment Analysis (&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">),</span>
<span class="w">          </span><span class="n">subtitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;log2(Enrichment) vs -log10(P-value)&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;log2(Enrichment)&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;-log10(P-value)&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Red circles: Top 1% -log10(P) &amp; Top 5% log2(Enrichment) \nP=0 capped at max finite -log10(P) + 10 with jitter&quot;</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Save plot to organized directory</span>
<span class="w">      </span><span class="n">output</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_enrichment_volcano_plot_combined.pdf&#39;</span><span class="p">))</span>
<span class="w">      </span><span class="n">width</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">45</span>
<span class="w">      </span><span class="n">height</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">plot_data_tmp</span><span class="o">$</span><span class="n">study</span><span class="p">))</span>
<span class="w">      </span><span class="nf">ggsave</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">limitsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Store plot for user access instead of intermediate files</span>
<span class="w">      </span><span class="n">plot_key</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;volcano_inf_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">      </span><span class="n">all_volcano_plots</span><span class="p">[[</span><span class="n">plot_key</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p</span>
<span class="p">}</span>

<span class="c1"># Function to display any volcano plot</span>
<span class="n">display_volcano_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">plot_key</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;volcano_inf_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">  </span><span class="kr">if</span><span class="p">(</span><span class="n">plot_key</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Displaying plot:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="c1"># Set dimensions for this specific display</span>
<span class="w">    </span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">height</span><span class="p">)</span>
<span class="w">      </span><span class="nf">print</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">[[</span><span class="n">plot_key</span><span class="p">]])</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Plot not found:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Available volcano plots:\n&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>


<span class="c1"># Function to list all available volcano plots</span>
<span class="n">list_volcano_plots</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Available volcano plots:\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="kr">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">)[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Function to save individual volcano plot to custom location</span>
<span class="n">save_volcano_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="n">file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">plot_key</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;volcano_inf_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">)</span>
<span class="w">  </span><span class="kr">if</span><span class="p">(</span><span class="n">plot_key</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">if</span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">file_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_custom_export.pdf&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nf">ggsave</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_volcano_plots</span><span class="p">[[</span><span class="n">plot_key</span><span class="p">]],</span><span class="w"> </span>
<span class="w">           </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">limitsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">    </span><span class="c1"># Removed two extra closing brackets: }) })</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Saved custom export to:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Plot not found:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Print summary</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;\n=== VOLCANO PLOT PROCESSING COMPLETE ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Total volcano plots created:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">all_volcano_plots</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n\n&quot;</span><span class="p">)</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;=== AVAILABLE FUNCTIONS ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• display_volcano_plot(&#39;data_type&#39;) - Show any volcano plot\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• list_volcano_plots() - See all available volcano plots\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;• save_volcano_plot(&#39;data_type&#39;) - Export specific volcano plot\n\n&quot;</span><span class="p">)</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;=== TO VIEW YOUR FIGURES ===\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;1. Open the directory:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;2. Look for files named: [data_type]_enrichment_volcano_plot_combined.pdf\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;3. Data types include: all, snuc_eQTL, multi_gene, multi_context, Epi, Other\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;4. Use display_volcano_plot(&#39;data_type&#39;) to view any plot in this notebook\n&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="test-between-methods">
<h2>Test between methods<a class="headerlink" href="#test-between-methods" title="Link to this heading">#</a></h2>
<section id="test-data">
<h3>Test data<a class="headerlink" href="#test-data" title="Link to this heading">#</a></h3>
<p>To identify annotations with significantly different enrichment values between the single-context (eQTL) and multi-gene (adj_eQTL) datasets, a statistical test was performed on annotations with significant enrichment (Enrichment_P_value &lt; 0.05) in at least one dataset. The datasets were merged by matching annotations, retaining only those significant in either dataset, and rows with missing or infinite values were excluded. Due to the non-normal distribution of enrichment differences (confirmed by a Shapiro-Wilk p-value of 5.623531e-60 in one context), a Z-score test was applied to each paired annotation, calculating the difference (Enrichment_adj - Enrichment_pqtl) divided by the combined standard error. P-values were derived from Z-scores and adjusted for multiple testing using the False Discovery Rate (FDR) method. Annotations with FDR-adjusted p-values &lt; 0.05 were considered significantly different, indicating systematic differences in enrichment between the single-context and multi-gene datasets for those annotations.</p>
</section>
<section id="multi-gene-to-single-context">
<h3>Multi gene to single context<a class="headerlink" href="#multi-gene-to-single-context" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">bulk_eQTL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_meta</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;eQTL&#39;</span><span class="p">)</span>
<span class="n">snuc_eQTL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_meta</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;snuc_eQTL&#39;</span><span class="p">)</span>
<span class="n">eQTL_raw</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rbind</span><span class="p">(</span><span class="n">bulk_eQTL</span><span class="p">,</span><span class="w"> </span><span class="n">snuc_eQTL</span><span class="p">)</span>
<span class="n">multi_gene_eQTL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_meta</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;multi_gene&#39;</span><span class="p">)</span>

<span class="c1"># build a modalities dict to combine single context and multi gene results </span>
<span class="n">modality_dict</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span>
<span class="w">  </span><span class="c1"># MSBB</span>
<span class="w">  </span><span class="s">&quot;BM_10_MSBB_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;MSBB_BM_10_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;BM_22_MSBB_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;MSBB_BM_22_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;BM_36_MSBB_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;MSBB_BM_36_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;BM_44_MSBB_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;MSBB_BM_44_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># DeJager and mega (ROSMAP)</span>
<span class="w">  </span><span class="s">&quot;AC_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_AC_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Ast_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Ast_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Ast_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Ast_mega_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;DLPFC_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_DLPFC_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Exc_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Exc_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Exc_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Exc_mega_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Inh_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Inh_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Inh_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Inh_mega_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Mic_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Mic_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Mic_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Mic_mega_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;monocyte_ROSMAP_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_monocyte_ROSMAP_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Oli_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Oli_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Oli_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Oli_mega_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;OPC_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_OPC_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;OPC_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_OPC_mega_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;PCC_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_PCC_DeJager_eQTL&quot;</span>
<span class="p">)</span>

<span class="n">eQTL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">eQTL_raw</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">modality_dict</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">recode</span><span class="p">(</span><span class="n">study</span><span class="p">,</span><span class="w"> </span><span class="o">!!!</span><span class="n">modality_dict</span><span class="p">))</span>
<span class="n">contexts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">modality_dict</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">as.character</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">bulk_eQTL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_meta</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;eQTL&#39;</span><span class="p">)</span>
<span class="n">snuc_eQTL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_meta</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;snuc_eQTL&#39;</span><span class="p">)</span>
<span class="n">eQTL_raw</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rbind</span><span class="p">(</span><span class="n">bulk_eQTL</span><span class="p">,</span><span class="w"> </span><span class="n">snuc_eQTL</span><span class="p">)</span>
<span class="n">multi_gene_eQTL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_meta</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;multi_gene&#39;</span><span class="p">)</span>

<span class="c1"># build a modalities dict to combine single context and multi gene results </span>
<span class="n">modality_dict</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span>
<span class="w">  </span><span class="c1"># MSBB</span>
<span class="w">  </span><span class="s">&quot;BM_10_MSBB_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;MSBB_BM_10_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;BM_22_MSBB_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;MSBB_BM_22_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;BM_36_MSBB_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;MSBB_BM_36_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;BM_44_MSBB_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;MSBB_BM_44_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># DeJager and mega (ROSMAP)</span>
<span class="w">  </span><span class="s">&quot;AC_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_AC_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Ast_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Ast_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Ast_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Ast_mega_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;DLPFC_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_DLPFC_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Exc_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Exc_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Exc_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Exc_mega_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Inh_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Inh_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Inh_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Inh_mega_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Mic_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Mic_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Mic_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Mic_mega_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;monocyte_ROSMAP_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_monocyte_ROSMAP_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Oli_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Oli_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Oli_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_Oli_mega_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;OPC_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_OPC_DeJager_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;OPC_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_OPC_mega_eQTL&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;PCC_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROSMAP_PCC_DeJager_eQTL&quot;</span>
<span class="p">)</span>
<span class="n">eQTL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">eQTL_raw</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">modality_dict</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">recode</span><span class="p">(</span><span class="n">study</span><span class="p">,</span><span class="w"> </span><span class="o">!!!</span><span class="n">modality_dict</span><span class="p">))</span>
<span class="w"> </span>
<span class="n">contexts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">modality_dict</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">as.character</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># List to store all enrichment difference plots for user access</span>
<span class="n">all_enrichment_diff_plots</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span>

<span class="n">combined_results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">map_dfr</span><span class="p">(</span><span class="n">contexts</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1"># Step 1: Filter significant annotations (Enrichment_P_value &lt; 0.05 in at least one dataset)</span>
<span class="w">      </span><span class="n">significant_single</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">eQTL</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">        </span><span class="nf">filter</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_P_value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">        </span><span class="nf">select</span><span class="p">(</span><span class="n">Annotation</span><span class="p">)</span>
<span class="w">      </span><span class="n">significant_multi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">multi_gene_eQTL</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">        </span><span class="nf">filter</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_P_value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">        </span><span class="nf">select</span><span class="p">(</span><span class="n">Annotation</span><span class="p">)</span>
<span class="w">      </span><span class="n">significant_annotations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">significant_single</span><span class="o">$</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">significant_multi</span><span class="o">$</span><span class="n">Annotation</span><span class="p">))</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Step 2: Merge datasets for significant annotations</span>
<span class="w">      </span><span class="n">merged_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">inner_join</span><span class="p">(</span>
<span class="w">        </span><span class="n">eQTL</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">          </span><span class="nf">filter</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Annotation</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">significant_annotations</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">          </span><span class="nf">select</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_single_context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_SE_single_context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_SE</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_P_value_single_context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_P_value</span><span class="p">),</span>
<span class="w">        </span><span class="n">multi_gene_eQTL</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">          </span><span class="nf">filter</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Annotation</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">significant_annotations</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">          </span><span class="nf">select</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_multi_gene</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_SE_multi_gene</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_SE</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_P_value_multi_gene</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_P_value</span><span class="p">),</span>
<span class="w">        </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Annotation&quot;</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">        </span><span class="nf">filter</span><span class="p">(</span><span class="nf">if_all</span><span class="p">(</span><span class="nf">starts_with</span><span class="p">(</span><span class="s">&quot;Enrichment&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">is.finite</span><span class="p">))</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Step 3: Check if there are valid paired observations</span>
<span class="w">      </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nf">nrow</span><span class="p">(</span><span class="n">merged_data</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nf">message</span><span class="p">(</span><span class="s">&quot;No valid paired observations for context: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Step 4: Perform Z-score test and calculate differences</span>
<span class="w">      </span><span class="n">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">merged_data</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">mutate</span><span class="p">(</span>
<span class="w">          </span><span class="n">Context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">,</span>
<span class="w">          </span><span class="n">Enrichment_Diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_multi_gene</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Enrichment_single_context</span><span class="p">,</span>
<span class="w">          </span><span class="n">Enrichment_SE_combined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="n">Enrichment_SE_single_context</span><span class="o">^</span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Enrichment_SE_multi_gene</span><span class="o">^</span><span class="m">2</span><span class="p">),</span>
<span class="w">          </span><span class="n">z_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_Diff</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Enrichment_SE_combined</span><span class="p">,</span>
<span class="w">          </span><span class="n">p_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">pnorm</span><span class="p">(</span><span class="o">-</span><span class="nf">abs</span><span class="p">(</span><span class="n">z_score</span><span class="p">)),</span>
<span class="w">          </span><span class="n">p_adjusted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">p.adjust</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fdr&quot;</span><span class="p">),</span>
<span class="w">          </span><span class="n">Significance_Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span>
<span class="w">            </span><span class="n">Enrichment_P_value_single_context</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Enrichment_P_value_multi_gene</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&quot;Both&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">Enrichment_P_value_single_context</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&quot;Single Context Only&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">Enrichment_P_value_multi_gene</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&quot;Multi-Gene Only&quot;</span>
<span class="w">          </span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">select</span><span class="p">(</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_single_context</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_multi_gene</span><span class="p">,</span>
<span class="w">               </span><span class="n">Enrichment_Diff</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_SE_single_context</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_SE_multi_gene</span><span class="p">,</span>
<span class="w">               </span><span class="n">Enrichment_P_value_single_context</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_P_value_multi_gene</span><span class="p">,</span><span class="w"> </span><span class="n">Significance_Status</span><span class="p">,</span>
<span class="w">               </span><span class="n">p_value</span><span class="p">,</span><span class="w"> </span><span class="n">p_adjusted</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1"># Step 5: Filter significant results (FDR &lt; 0.05)</span>
<span class="w">      </span><span class="n">significant</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">p_adjusted</span><span class="p">),</span><span class="w"> </span><span class="n">p_adjusted</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">grepl</span><span class="p">(</span><span class="s">&quot;\\|&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Annotation</span><span class="p">),</span>
<span class="w">                                 </span><span class="nf">str_split</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\\|&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">simplify</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)[,</span><span class="w"> </span><span class="m">1</span><span class="p">],</span><span class="w"> </span>
<span class="w">                                 </span><span class="n">Annotation</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">        </span><span class="nf">distinct</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">.keep_all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="w">      </span>
<span class="w">      </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nf">nrow</span><span class="p">(</span><span class="n">significant</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">plot_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">significant</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">          </span><span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">Enrichment_Diff</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">          </span><span class="nf">slice_head</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">          </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">make.unique</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">Annotation</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">          </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Annotation</span><span class="p">))</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ggplot</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_Diff</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Category</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;identity&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;dashed&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">labs</span><span class="p">(</span>
<span class="w">            </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Top Enrichment Differences for &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">),</span>
<span class="w">            </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Enrichment Difference (multi_gene - single_context)&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">          </span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">theme_minimal</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="nf">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_colors</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1"># Save plot to organized directory</span>
<span class="w">        </span><span class="n">dir_name</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&#39;methods_compare/multi_gene&#39;</span>
<span class="w">        </span><span class="n">dir_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">main_output_dir</span><span class="p">,</span><span class="w"> </span><span class="n">dir_name</span><span class="p">)</span>
<span class="w">        </span><span class="nf">dir.create</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="n">recursive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">showWarnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">        </span><span class="n">out_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_multigene_single_enrichment_plot_combined.pdf&#39;</span><span class="p">))</span>
<span class="w">        </span><span class="nf">ggsave</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">14</span><span class="p">,</span><span class="w"> </span><span class="n">limitsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1"># Store plot for user access</span>
<span class="w">        </span><span class="n">plot_key</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;enrichment_diff_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<span class="w">        </span><span class="n">all_enrichment_diff_plots</span><span class="p">[[</span><span class="n">plot_key</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="n">results</span>
<span class="p">})</span>

<span class="c1"># Filter for significant results and plot summary</span>
<span class="n">significant_results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">combined_results</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">p_adjusted</span><span class="p">),</span><span class="w"> </span><span class="n">p_adjusted</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">str_extract</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;^[^|]+&quot;</span><span class="p">))</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Number of significantly different annotations (FDR &lt; 0.05):&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">nrow</span><span class="p">(</span><span class="n">significant_results</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of significantly different annotations (FDR &lt; 0.05): 3312 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Summary plot of differences between single and multi gene finemapping methods</span>
<span class="n">top_num</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2</span>
<span class="n">plot_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">significant_results</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">group_by</span><span class="p">(</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">Enrichment_Diff</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">slice_head</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top_num</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="n">Annotation</span><span class="p">)))</span>

<span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ggplot</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_Diff</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_Diff</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;identity&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;skyblue&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;salmon&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">guide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;none&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;dashed&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">labs</span><span class="p">(</span>
<span class="w">    </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Top Enrichment Differences for Significant Annotations (FDR &lt; 0.05)&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Enrichment Difference (multi_gene - single_context)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;free_y&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme_minimal</span><span class="p">(</span><span class="n">base_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">  </span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span>
<span class="w">    </span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">36</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">margin</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">)),</span>
<span class="w">    </span><span class="n">strip.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">32</span><span class="p">),</span>
<span class="w">    </span><span class="n">axis.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">28</span><span class="p">),</span>
<span class="w">    </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">margin</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">)),</span><span class="w">  </span>
<span class="w">    </span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="p">),</span>
<span class="w">    </span><span class="n">panel.spacing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unit</span><span class="p">(</span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;lines&quot;</span><span class="p">),</span><span class="w">  </span>
<span class="w">    </span><span class="n">plot.margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">margin</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">)</span>

<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="m">100</span><span class="p">)</span>
<span class="n">p</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/3ad54ee9b1c367786390abcc488e4acf3cecb0660fb4ade0d1270e0bbf76189d.png"><img alt="../../_images/3ad54ee9b1c367786390abcc488e4acf3cecb0660fb4ade0d1270e0bbf76189d.png" src="../../_images/3ad54ee9b1c367786390abcc488e4acf3cecb0660fb4ade0d1270e0bbf76189d.png" style="width: 3600px; height: 6000px;" />
</a>
</div>
</div>
</section>
<section id="multi-context-to-single-context">
<h3>Multi context to single context<a class="headerlink" href="#multi-context-to-single-context" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">enrichment_data_meta</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;multi_context&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">pull</span><span class="p">(</span><span class="n">study</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">unique</span><span class="w"> </span>

<span class="c1"># Filter eQTL data</span>
<span class="n">bulk_eQTL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_meta</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;eQTL&#39;</span><span class="p">)</span>
<span class="n">snuc_eQTL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_meta</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;snuc_eQTL&#39;</span><span class="p">)</span>
<span class="n">eQTL_raw</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rbind</span><span class="p">(</span><span class="n">bulk_eQTL</span><span class="p">,</span><span class="w"> </span><span class="n">snuc_eQTL</span><span class="p">)</span>
<span class="n">multi_context_eQTL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">enrichment_data_meta</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">`Data Type`</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#39;multi_context&#39;</span><span class="p">)</span>

<span class="c1"># Build a modalities dict to combine single context and multi gene results</span>
<span class="n">modality_dict_multicontext</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span>
<span class="w">  </span><span class="s">&quot;AC_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;AC_DeJager_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;DLPFC_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;DLPFC_DeJager_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;PCC_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;PCC_DeJager_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Ast_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Ast_DeJager_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Inh_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Inh_DeJager_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Exc_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Exc_DeJager_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Mic_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mic_DeJager_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;OPC_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;OPC_DeJager_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Oli_DeJager_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Oli_DeJager_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;PCC_Kellis_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;PCC_Kellis_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Ast_Kellis_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Ast_Kellis_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Inh_Kellis_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Inh_Kellis_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Exc_Kellis_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Exc_Kellis_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Mic_Kellis_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mic_Kellis_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;OPC_Kellis_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;OPC_Kellis_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Oli_Kellis_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Oli_Kellis_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;PCC_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;PCC_mega_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Ast_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Ast_mega_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Inh_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Inh_mega_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Exc_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Exc_mega_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Mic_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Mic_mega_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;OPC_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;OPC_mega_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;Oli_mega_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Oli_mega_eQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;DLPFC_Bennett_pQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;DLPFC_Bennett_pQTL_multicontext&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;monocyte_ROSMAP_eQTL&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;monocyte_ROSMAP_eQTL_multicontext&quot;</span>

<span class="p">)</span>

<span class="c1"># Harmonize study names</span>
<span class="n">eQTL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">eQTL_raw</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">filter</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">modality_dict_multicontext</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">recode</span><span class="p">(</span><span class="n">study</span><span class="p">,</span><span class="w"> </span><span class="o">!!!</span><span class="n">modality_dict_multicontext</span><span class="p">))</span>

<span class="n">multi_context_eQTL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">multi_context_eQTL</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">filter</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">modality_dict_multicontext</span><span class="p">))</span>

<span class="c1"># Compare enrichment across modalities</span>
<span class="n">contexts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">modality_dict_multicontext</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>'AC_DeJager_eQTL_multicontext'</li><li>'Ast_DeJager_eQTL_multicontext'</li><li>'Ast_Kellis_eQTL_multicontext'</li><li>'Ast_mega_eQTL_multicontext'</li><li>'DLPFC_Bennett_pQTL_multicontext'</li><li>'DLPFC_DeJager_eQTL_multicontext'</li><li>'Exc_DeJager_eQTL_multicontext'</li><li>'Exc_Kellis_eQTL_multicontext'</li><li>'Exc_mega_eQTL_multicontext'</li><li>'Inh_DeJager_eQTL_multicontext'</li><li>'Inh_Kellis_eQTL_multicontext'</li><li>'Inh_mega_eQTL_multicontext'</li><li>'Mic_DeJager_eQTL_multicontext'</li><li>'Mic_Kellis_eQTL_multicontext'</li><li>'Mic_mega_eQTL_multicontext'</li><li>'OPC_DeJager_eQTL_multicontext'</li><li>'OPC_Kellis_eQTL_multicontext'</li><li>'OPC_mega_eQTL_multicontext'</li><li>'Oli_DeJager_eQTL_multicontext'</li><li>'Oli_Kellis_eQTL_multicontext'</li><li>'Oli_mega_eQTL_multicontext'</li><li>'PCC_DeJager_eQTL_multicontext'</li><li>'monocyte_ROSMAP_eQTL_multicontext'</li></ol>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">combined_results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">map_dfr</span><span class="p">(</span><span class="n">contexts</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="n">significant_single</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">eQTL</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">    </span><span class="nf">filter</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_P_value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">    </span><span class="nf">select</span><span class="p">(</span><span class="n">Annotation</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="n">significant_multi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">multi_context_eQTL</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">    </span><span class="nf">filter</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_P_value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">    </span><span class="nf">select</span><span class="p">(</span><span class="n">Annotation</span><span class="p">)</span><span class="w"> </span>
<span class="n">significant_annotations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">significant_single</span><span class="o">$</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">significant_multi</span><span class="o">$</span><span class="n">Annotation</span><span class="p">))</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Step 2: Merge datasets for significant annotations </span>
<span class="w">  </span><span class="n">merged_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">inner_join</span><span class="p">(</span><span class="w"> </span>
<span class="w">    </span><span class="n">eQTL</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">      </span><span class="nf">filter</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Annotation</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">significant_annotations</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">      </span><span class="nf">select</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_single_context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_SE_single_context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_SE</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_P_value_single_context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_P_value</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="n">multi_context_eQTL</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">      </span><span class="nf">filter</span><span class="p">(</span><span class="n">study</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Annotation</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">significant_annotations</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">      </span><span class="nf">select</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_multi_gene</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_SE_multi_gene</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_SE</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_P_value_multi_gene</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_P_value</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Annotation&quot;</span><span class="w"> </span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">    </span><span class="nf">filter</span><span class="p">(</span><span class="nf">if_all</span><span class="p">(</span><span class="nf">starts_with</span><span class="p">(</span><span class="s">&quot;Enrichment&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">is.finite</span><span class="p">))</span><span class="w"> </span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Step 3: Check if there are valid paired observations </span>
<span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nf">nrow</span><span class="p">(</span><span class="n">merged_data</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nf">message</span><span class="p">(</span><span class="s">&quot;No valid paired observations for context: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="kr">return</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Step 4: Perform Z-score test and calculate differences </span>
<span class="w">  </span><span class="n">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">merged_data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">    </span><span class="nf">mutate</span><span class="p">(</span><span class="w"> </span>
<span class="w">      </span><span class="n">Context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="n">Enrichment_Diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_multi_gene</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Enrichment_single_context</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="n">Enrichment_SE_combined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="n">Enrichment_SE_single_context</span><span class="o">^</span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Enrichment_SE_multi_gene</span><span class="o">^</span><span class="m">2</span><span class="p">),</span><span class="w"> </span>
<span class="w">      </span><span class="n">z_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_Diff</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Enrichment_SE_combined</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="n">p_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">pnorm</span><span class="p">(</span><span class="o">-</span><span class="nf">abs</span><span class="p">(</span><span class="n">z_score</span><span class="p">)),</span><span class="w"> </span>
<span class="w">      </span><span class="n">p_adjusted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">p.adjust</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fdr&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">      </span><span class="n">Significance_Status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span><span class="w"> </span>
<span class="w">        </span><span class="n">Enrichment_P_value_single_context</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Enrichment_P_value_multi_gene</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&quot;Both&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">Enrichment_P_value_single_context</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&quot;Single Context Only&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">Enrichment_P_value_multi_gene</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&quot;Multi-Gene Only&quot;</span><span class="w"> </span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">    </span><span class="nf">select</span><span class="p">(</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_single_context</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_multi_gene</span><span class="p">,</span><span class="w"> </span>
<span class="w">           </span><span class="n">Enrichment_Diff</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_SE_single_context</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_SE_multi_gene</span><span class="p">,</span><span class="w"> </span>
<span class="w">           </span><span class="n">Enrichment_P_value_single_context</span><span class="p">,</span><span class="w"> </span><span class="n">Enrichment_P_value_multi_gene</span><span class="p">,</span><span class="w"> </span><span class="n">Significance_Status</span><span class="p">,</span><span class="w"> </span>
<span class="w">           </span><span class="n">p_value</span><span class="p">,</span><span class="w"> </span><span class="n">p_adjusted</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Step 5: Filter significant results (FDR &lt; 0.05) </span>
<span class="w">  </span><span class="n">significant</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">    </span><span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">p_adjusted</span><span class="p">),</span><span class="w"> </span><span class="n">p_adjusted</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">    </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">grepl</span><span class="p">(</span><span class="s">&quot;\\|&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Annotation</span><span class="p">),</span><span class="w"> </span>
<span class="w">                             </span><span class="nf">str_split</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\\|&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">simplify</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)[,</span><span class="w"> </span><span class="m">1</span><span class="p">],</span><span class="w"> </span>
<span class="w">                             </span><span class="n">Annotation</span><span class="p">))</span><span class="w">  </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">distinct</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">.keep_all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">T</span><span class="p">)</span>

<span class="w">  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nf">nrow</span><span class="p">(</span><span class="n">significant</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="n">plot_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">significant</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">      </span><span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">Enrichment_Diff</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">      </span><span class="nf">slice_head</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">      </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Annotation</span><span class="p">))</span><span class="w"> </span>
<span class="w">    </span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ggplot</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_Diff</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Category</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">      </span><span class="nf">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;identity&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">      </span><span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;dashed&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">      </span><span class="nf">labs</span><span class="p">(</span><span class="w"> </span>
<span class="w">        </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Top Enrichment Differences for &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Enrichment Difference (multi_context - single_context)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">      </span><span class="nf">theme_minimal</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">      </span><span class="nf">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">      </span><span class="nf">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_colors</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span>
<span class="w">    </span><span class="n">out_path</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">file.path</span><span class="p">(</span><span class="s">&#39;~/restricted/projectnb/xqtl/jaempawi/xqtl&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                          </span><span class="s">&#39;methods_compare/multi_context/&#39;</span><span class="p">,</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;_multigene_single_enrichment_plot_combined.pdf&#39;</span><span class="p">))</span><span class="w">    </span><span class="c1">#FIXME</span>
<span class="w">    </span><span class="nf">dir.create</span><span class="p">(</span><span class="nf">dirname</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span><span class="w"> </span><span class="n">recursive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">showWarnings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="nf">ggsave</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span><span class="w"> </span><span class="n">plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">14</span><span class="p">,</span><span class="w"> </span><span class="n">limitsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span>
<span class="w">  </span>
<span class="w">  </span><span class="n">results</span><span class="w"> </span>
<span class="p">})</span>

<span class="c1"># Filter for significant results and plot summary</span>
<span class="n">significant_results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">combined_results</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">filter</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">p_adjusted</span><span class="p">),</span><span class="w"> </span><span class="n">p_adjusted</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">str_extract</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;^[^|]+&quot;</span><span class="p">))</span>

<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Number of significantly different annotations (FDR &lt; 0.05):&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">nrow</span><span class="p">(</span><span class="n">significant_results</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No valid paired observations for context: PCC_Kellis_eQTL_multicontext

No valid paired observations for context: PCC_mega_eQTL_multicontext

No valid paired observations for context: DLPFC_Bennett_pQTL_multicontext
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of significantly different annotations (FDR &lt; 0.05): 2321 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Summary plot of the differences between single and multi context eQTL methods</span>
<span class="n">top_num</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2</span>
<span class="n">plot_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">significant_results</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">group_by</span><span class="p">(</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">Enrichment_Diff</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">slice_head</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top_num</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">Annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">factor</span><span class="p">(</span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="n">Annotation</span><span class="p">)))</span>

<span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ggplot</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_Diff</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Annotation</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Enrichment_Diff</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;identity&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;skyblue&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;salmon&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">guide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;none&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;dashed&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">labs</span><span class="p">(</span>
<span class="w">    </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Top Enrichment Differences for Significant Annotations (FDR &lt; 0.05)&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Enrichment Difference (multi_context - single_context)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;free_y&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme_minimal</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">36</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">margin</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">)),</span>
<span class="w">    </span><span class="n">strip.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">32</span><span class="p">),</span>
<span class="w">    </span><span class="n">axis.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;bold&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">28</span><span class="p">),</span>
<span class="w">    </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">margin</span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">)),</span><span class="w">  </span>
<span class="w">    </span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="p">),</span>
<span class="w">    </span><span class="n">panel.spacing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unit</span><span class="p">(</span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;lines&quot;</span><span class="p">),</span><span class="w">  </span>
<span class="w">    </span><span class="n">plot.margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">margin</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">))</span><span class="w"> </span>

<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">)</span>
<span class="n">p</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/53fa62d78057f66001b19f3ff87f30abea35f6c395c734752008a717d1cc10ac.png"><img alt="../../_images/53fa62d78057f66001b19f3ff87f30abea35f6c395c734752008a717d1cc10ac.png" src="../../_images/53fa62d78057f66001b19f3ff87f30abea35f6c395c734752008a717d1cc10ac.png" style="width: 3600px; height: 6000px;" />
</a>
</div>
</div>
</section>
</section>
</section>
<section id="summary-of-updated-multi-context-eoo-results">
<h1>Summary of Updated Multi-Context EOO Results<a class="headerlink" href="#summary-of-updated-multi-context-eoo-results" title="Link to this heading">#</a></h1>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1.	The updated results include more contexts than the previous version (Apr 2025).
2.	Overall patterns remain similar, especially when comparing across AC.
3.  Subset of annotations shows significant differences in enrichment between the multi-context and single-context models (FDR &lt; 0.05).
4.	The magnitude and direction of enrichment differences vary across annotations.
5.	Some annotations (e.g., PU1 promoter/enhancer in microglia) show higher enrichment in the multi-context model.
6.	Others (e.g., LHX2 promoter in astrocytes) show higher enrichment in the single-context model.
7.	The pattern of differences is not consistent across cell types or annotation categories.
</pre></div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            name: "ir",
            path: "./main_text/2_single_context_cis"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Figure_1b_num_xQTL_loci_single_context.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Figure 1b. Number of detectable and mappable xQTL loci in single−context fine−mapping</p>
      </div>
    </a>
    <a class="right-next"
       href="Figure_S2_single_context_cs_distance.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Frequency of Events in Distance Category</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">EOO results</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#eoo-visualization">EOO Visualization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-libraries-and-data">Load libraries and data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#barplot">Barplot</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#enrichment-plot-for-each-context">Enrichment plot for each context</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#top-combined-enrichment-plot-by-category">Top combined enrichment plot by category</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#top-combined-enrichment-plot-by-category-for-cell-type-marker">Top combined enrichment plot by category for cell type marker</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#volcano-plot">Volcano plot</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#volcano-plot-without-inf-logp">Volcano plot without Inf logP</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#volcano-plot-with-inf-logp">Volcano plot with Inf logP</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-between-methods">Test between methods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test-data">Test data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-gene-to-single-context">Multi gene to single context</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-context-to-single-context">Multi context to single context</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-of-updated-multi-context-eoo-results">Summary of Updated Multi-Context EOO Results</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FunGen-AD Consortium
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>